#!/bin/bash -e

PATH=/bin/:/usr/bin:$PATH

source $OPENSHIFT_CARTRIDGE_SDK_BASH
APPNAME=httpserver

function start {
    #/usr/sbin/httpd -f $OPENSHIFT_EXAMPLE_DIR/etc/httpd.conf -k start
    nohup java -cp $OPENSHIFT_REPO_DIR/lib/httpserver.jar com.example.Test > $OPENSHIFT_EXAMPLE_DIR/logs/server.log 2>&1 &
    echo $! >$OPENSHIFT_REPO_DIR/server.pid
}

function stop {
    #/usr/sbin/httpd -f $OPENSHIFT_EXAMPLE_DIR/etc/httpd.conf -k stop
    if [ -e $OPENSHIFT_REPO_DIR/server.pid ] ; then
        kill `cat $OPENSHIFT_REPO_DIR/server.pid`
        rm $OPENSHIFT_REPO_DIR/server.pid
        client_result "The server has been killed."
    else
        client_result "server.pid file could not be found."
    fi
    if [ -n "$(ps -ef | grep $APPNAME | grep -v grep)" ] ; then
        client_result "Application was not stopped by server.pid method"
        kill `ps -ef | grep $APPNAME | grep -v grep | awk '{ print $2 }'` > /dev/null 2>&1
        if [ -n "$(ps -ef | grep $APPNAME | grep -v grep)" ] ; then
            client_result "Application was not stopped grep method"
        fi     
    fi
}

function restart {
    #/usr/sbin/httpd -f $OPENSHIFT_EXAMPLE_DIR/etc/httpd.conf -k restart
    stop
    start
}

function catchall {
    echo "not yet implemented"
}

case "$1" in
  start)       start ;;
  stop)        stop ;;
  restart)     restart ;;
  status)      status ;;
  reload)      catchall ;;
  tidy)        catchall ;;
  pre-build)   catchall ;;
  build)       catchall ;;
  deploy)      catchall ;;
  post-deploy) catchall ;;
  *)           exit 0
esac

exit 0
